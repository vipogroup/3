# 🔐 דוח בדיקת אבטחה מקיפה - מערכת VIPO

**תאריך:** 27 בדצמבר 2025  
**סוג בדיקה:** Production Security Audit  
**רמת חומרה:** לפני השקה לפרודקשן

---

## סיכום מנהלים

| קטגוריה | סטטוס |
|---------|-------|
| **בעיות קריטיות** | 🔴 1 |
| **בעיות גבוהות** | 🟠 2 |
| **בעיות בינוניות** | 🟡 3 |
| **בעיות נמוכות** | 🟢 2 |

**החלטה:** ⚠️ **לא מוכן להשקה** - יש לתקן את הבעיה הקריטית לפני עלייה לפרודקשן.

---

## 1. נקודות כניסה (Entry Points)

### 1.1 דפים ציבוריים (44 דפים)
- `/` - דף בית (iframe)
- `/products`, `/products/[id]` - קטלוג מוצרים
- `/cart`, `/checkout` - תהליך רכישה
- `/login`, `/register` - אימות
- `/join` - הצטרפות כסוכן
- `/r/[code]` - הפניית רפרל

### 1.2 טפסים
| טופס | מיקום | Rate Limit |
|------|-------|------------|
| Login | `/login` | ✅ 5/דקה |
| Register | `/register` | ✅ 3/דקה |
| OTP | `/api/auth/send-otp` | ✅ 3/דקה |
| Checkout | `/checkout` | ✅ 10/דקה |

### 1.3 APIs (40 נתיבים)
- **מוגנים:** 37 נתיבים עם `requireAuthApi` / `requireAdminApi`
- **ציבוריים:** 3 נתיבים (login, register, health)

### 1.4 נתיבים נסתרים/בעייתיים

| נתיב | סטטוס | חומרה |
|------|-------|--------|
| `/api/list-users` | 🔴 **ללא הגנה!** | קריטי |
| `/api/dev/magic-login` | ✅ חסום בפרודקשן | תקין |
| `/api/dev/seed-products` | ✅ חסום בפרודקשן | תקין |

---

## 2. סיכוני אימות והרשאות

### 🔴 קריטי: `/api/list-users` - חשיפת משתמשים

**בעיה:** הנתיב `/api/list-users` חושף את **כל המשתמשים במערכת** ללא שום אימות!

**מה נחשף:**
```json
{
  "_id": "...",
  "email": "user@example.com",
  "phone": "0501234567",
  "role": "admin/agent/customer",
  "fullName": "שם מלא",
  "hasPassword": true,
  "passwordLength": 60
}
```

**תרחיש תקיפה:**
1. תוקף מבצע GET ל-`/api/list-users`
2. מקבל רשימת כל המשתמשים עם emails ומספרי טלפון
3. יכול לבצע brute-force על חשבונות Admin
4. יכול למכור את המידע / לבצע phishing

**תיקון נדרש:**
```javascript
// הוסף בתחילת הפונקציה:
import { requireAdminApi } from '@/lib/auth/server';

export async function GET(req) {
  await requireAdminApi(req); // הוסף שורה זו!
  // ...
}
```

---

### 🟠 גבוה: Session Token בלי Secure flag

**קובץ:** `app/api/dev/magic-login/route.js`

```javascript
res.cookies.set('token', token, {
  httpOnly: true,
  sameSite: 'lax',
  secure: false, // ⚠️ בעיה!
  path: '/',
});
```

**בעיה:** גם אם זה רק ב-dev, ייתכן שהקוד משמש גם נתיבים אחרים.

---

### 🟠 גבוה: בדיקת תפקיד לא אחידה

**נמצאו שני סגנונות שונים לבדיקת הרשאות:**

1. **סגנון ישן (פחות בטוח):**
```javascript
function ensureAdmin(req) {
  const decoded = verifyJwt(getToken(req));
  if (!decoded || decoded.role !== 'admin') return null;
  return decoded;
}
```

2. **סגנון חדש (מומלץ):**
```javascript
await requireAdminApi(req);
```

**המלצה:** לאחד את כל הקוד לשימוש ב-`requireAdminApi` בלבד.

---

## 3. סיכוני OWASP Top 10

### A01:2021 - Broken Access Control

| ממצא | חומרה | סטטוס |
|------|--------|-------|
| `/api/list-users` ללא auth | 🔴 קריטי | **לתקן!** |
| IDOR בהזמנות | ✅ מוגן | תקין |
| הפרדת תפקידים | ✅ מיושם | תקין |

### A02:2021 - Cryptographic Failures

| ממצא | חומרה | סטטוס |
|------|--------|-------|
| סיסמאות ב-bcrypt | ✅ | תקין |
| JWT חתום | ✅ | תקין |
| HTTPS | ✅ | תקין (Vercel) |

### A03:2021 - Injection

| ממצא | חומרה | סטטוס |
|------|--------|-------|
| MongoDB Injection | ✅ מוגן | Mongoose sanitization |
| XSS | ✅ מוגן | React escaping |
| NoSQL Injection | ✅ מוגן | ObjectId validation |

### A07:2021 - Cross-Site Scripting (XSS)

| ממצא | חומרה | סטטוס |
|------|--------|-------|
| CSP Headers | ✅ מוגדר | `next.config.js` |
| X-XSS-Protection | ✅ מוגדר | `1; mode=block` |

---

## 4. חשיפת API ו-Client

### 🟡 בינוני: מידע בתגובות שגיאה

**בעיה:** חלק מהתגובות חושפות מידע על מבנה המערכת:

```javascript
// בעייתי:
return NextResponse.json({ error: error.message }, { status: 500 });

// מומלץ:
return NextResponse.json({ error: 'Server error' }, { status: 500 });
```

### 🟡 בינוני: Console.log בפרודקשן

נמצאו **64 קריאות console.log** ב-API routes.

**המלצה:** להסיר או להחליף ב-logging מקצועי.

### ✅ תקין: אין חשיפת passwordHash

כל הקריאות ל-users מסננות את `passwordHash`:
```javascript
projection: { passwordHash: 0, password: 0 }
```

---

## 5. Transport & Headers

### Security Headers (next.config.js)

| Header | ערך | סטטוס |
|--------|-----|-------|
| X-Content-Type-Options | `nosniff` | ✅ |
| X-XSS-Protection | `1; mode=block` | ✅ |
| Referrer-Policy | `strict-origin-when-cross-origin` | ✅ |
| Permissions-Policy | `camera=(), microphone=(), geolocation=()` | ✅ |
| Content-Security-Policy | מוגדר | ✅ |
| X-Frame-Options | `frame-ancestors 'none'` | ✅ |

### 🟡 בינוני: CORS

**לא נמצאה הגדרת CORS מפורשת.** Next.js משתמש ב-default restrictive CORS.

**המלצה:** להוסיף הגדרת CORS מפורשת אם יש צורך ב-cross-origin requests.

---

## 6. Rate Limiting

### מצב נוכחי

| נתיב | Rate Limit | סטטוס |
|------|------------|-------|
| `/api/auth/login` | 5/דקה | ✅ |
| `/api/auth/register` | 3/דקה | ✅ |
| `/api/auth/send-otp` | 3/דקה | ✅ |
| `/api/payplus/*` | 10/דקה | ✅ |
| `/api/products` (GET) | ללא | 🟢 תקין (ציבורי) |

### 🟢 נמוך: Automation Bypass

קיים מנגנון bypass עם `x-automation-key`:
```javascript
const hasAutomationBypass = (req) => {
  const headerValue = req.headers.get('x-automation-key');
  if (headerValue && headerValue === automationKey) return true;
};
```

**המלצה:** לוודא שה-`AUTOMATION_KEY` מוגדר ומורכב בפרודקשן.

---

## 7. סיווג חומרות

### 🔴 קריטי (1)

| בעיה | קובץ | תיקון |
|------|------|-------|
| `/api/list-users` ללא auth | `app/api/list-users/route.js` | הוסף `requireAdminApi` |

### 🟠 גבוה (2)

| בעיה | קובץ | תיקון |
|------|------|-------|
| Session בלי secure flag | `app/api/dev/magic-login/route.js` | שנה ל-`secure: true` |
| בדיקת הרשאות לא אחידה | מספר קבצים | איחוד ל-`requireAdminApi` |

### 🟡 בינוני (3)

| בעיה | תיקון |
|------|-------|
| מידע בשגיאות | הסתר פרטי שגיאה |
| console.log בקוד | הסר/החלף ב-logger |
| CORS לא מפורש | הגדר CORS policy |

### 🟢 נמוך (2)

| בעיה | תיקון |
|------|-------|
| Automation bypass | וודא key מורכב |
| 45 קבצי MD מיותרים | ניקוי (לא אבטחה) |

---

## 8. החלטה לפני השקה

### ❌ לא מוכן להשקה

**סיבה עיקרית:** `/api/list-users` חושף את כל המשתמשים במערכת ללא אימות.

### פעולות נדרשות לפני השקה:

| עדיפות | פעולה | זמן משוער |
|--------|-------|-----------|
| 1 | תיקון `/api/list-users` | 5 דקות |
| 2 | איחוד בדיקות הרשאה | 30 דקות |
| 3 | הסרת console.log | 15 דקות |

### לאחר התיקונים:

✅ **המערכת תהיה מוכנה להשקה** עם רמת אבטחה טובה:
- אימות JWT חזק
- הצפנת סיסמאות תקינה
- Security headers מוגדרים
- Rate limiting פעיל
- CSP מוגדר

---

## 9. המלצות נוספות (לא חוסמות)

1. **הוסף 2FA** לחשבונות Admin
2. **הוסף Audit Log** לפעולות רגישות
3. **הגדר IP Whitelist** לדף Admin (אופציונלי)
4. **בצע Penetration Test** לפני השקה רשמית

---

**דוח הוכן על ידי:** Senior Application Security Engineer  
**תאריך:** 27 בדצמבר 2025
